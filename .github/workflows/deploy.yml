name: Deploy Website

on:
  push:
    branches:
      - gh-pages
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'
          cache: 'npm'

      - name: Install Dependencies
        run: |
          npm install
          npm run setup
          npm install -g postcss-cli esbuild html-minifier imagemin-cli

      - name: Build
        run: |
          cd website
          cp -r * ../dist/
          cd ..
          npm run build:all
        env:
          NODE_ENV: production
          WEBSITE_URL: ${{ secrets.WEBSITE_URL || 'https://ngulliinsights.github.io/Obvious_Company' }}

      - name: Setup Pages
        uses: actions/configure-pages@v3

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: dist

  deploy:
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2

      - name: Optimize Assets
        run: |
          npm run build:css

      - name: Setup Pages
        uses: actions/configure-pages@v3

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: './website'

  deploy:
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2
=======
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4  # Updated to latest stable version for better security and performance
        with:
          ref: gh-pages           # Explicitly specify branch (redundant but clear)
          fetch-depth: 1          # Shallow clone for faster checkout since we only need current state

      - name: Validate website directory
        run: |
          # Verify the website directory exists and contains files
          if [ ! -d "./website" ]; then
            echo "Error: ./website directory not found in gh-pages branch"
            echo "Please ensure your build process outputs files to ./website directory"
            exit 1
          fi

          # Check if directory has content
          file_count=$(find ./website -type f | wc -l)
          if [ "$file_count" -eq 0 ]; then
            echo "Error: ./website directory is empty"
            echo "No files found to deploy"
            exit 1
          fi

          echo "Found $file_count files ready for deployment"

      - name: Setup GitHub Pages configuration
        uses: actions/configure-pages@v4  # Updated to v4 for improved reliability and features

      - name: Upload website artifact to Pages
        uses: actions/upload-pages-artifact@v2  # Updated to v2 for better performance
        with:
          path: './website'
          retention-days: 1  # Clean up deployment artifacts after 1 day to save storage

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v3  # Updated to v3 for enhanced deployment capabilities

      - name: Report deployment success
        run: |
          echo "ğŸš€ Deployment completed successfully!"
          echo "ğŸ“ Site URL: ${{ steps.deployment.outputs.page_url }}"
          echo "â° Deployed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

          # Optional: Verify the deployment is accessible
          echo "ğŸ” Verifying site accessibility..."
          if curl -f -s -o /dev/null -w "%{http_code}" "${{ steps.deployment.outputs.page_url }}" | grep -q "200"; then
            echo "âœ… Site is responding successfully"
          else
            echo "âš ï¸  Site may still be propagating (this is normal for new deployments)"
          fi
>>>>>>> 7254992874be9ac10591b2e18466014db648fded
